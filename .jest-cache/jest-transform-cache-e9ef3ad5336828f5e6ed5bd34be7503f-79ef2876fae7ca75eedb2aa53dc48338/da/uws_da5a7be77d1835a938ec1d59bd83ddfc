818e4efc683c9248f90cc9dbfb3f2ad7
"use strict";

var __importDefault = void 0 && (void 0).__importDefault || function (mod) {
  return mod && mod.__esModule ? mod : {
    "default": mod
  };
};
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.patchAdapter = patchAdapter;
exports.restoreAdapter = restoreAdapter;
exports.serveFile = serveFile;
const socket_io_adapter_1 = require("socket.io-adapter");
const fs_1 = require("fs");
const debug_1 = __importDefault(require("debug"));
const debug = (0, debug_1.default)("socket.io:adapter-uws");
const SEPARATOR = "\x1f"; // see https://en.wikipedia.org/wiki/Delimiter#ASCII_delimited_text
const {
  addAll,
  del,
  broadcast
} = socket_io_adapter_1.Adapter.prototype;
function patchAdapter(app /* : TemplatedApp */) {
  socket_io_adapter_1.Adapter.prototype.addAll = function (id, rooms) {
    const isNew = !this.sids.has(id);
    addAll.call(this, id, rooms);
    const socket = this.nsp.sockets.get(id) || this.nsp._preConnectSockets.get(id);
    if (!socket) {
      return;
    }
    if (socket.conn.transport.name === "websocket") {
      subscribe(this.nsp.name, socket, isNew, rooms);
      return;
    }
    if (isNew) {
      socket.conn.on("upgrade", () => {
        const rooms = this.sids.get(id);
        if (rooms) {
          subscribe(this.nsp.name, socket, isNew, rooms);
        }
      });
    }
  };
  socket_io_adapter_1.Adapter.prototype.del = function (id, room) {
    del.call(this, id, room);
    const socket = this.nsp.sockets.get(id) || this.nsp._preConnectSockets.get(id);
    if (socket && socket.conn.transport.name === "websocket") {
      // @ts-ignore
      const sessionId = socket.conn.id;
      // @ts-ignore
      const websocket = socket.conn.transport.socket;
      const topic = `${this.nsp.name}${SEPARATOR}${room}`;
      debug("unsubscribe connection %s from topic %s", sessionId, topic);
      websocket.unsubscribe(topic);
    }
  };
  socket_io_adapter_1.Adapter.prototype.broadcast = function (packet, opts) {
    const useFastPublish = opts.rooms.size <= 1 && opts.except.size === 0;
    if (!useFastPublish) {
      broadcast.call(this, packet, opts);
      return;
    }
    const flags = opts.flags || {};
    const basePacketOpts = {
      preEncoded: true,
      volatile: flags.volatile,
      compress: flags.compress
    };
    packet.nsp = this.nsp.name;
    const encodedPackets = this.encoder.encode(packet);
    const topic = opts.rooms.size === 0 ? this.nsp.name : `${this.nsp.name}${SEPARATOR}${opts.rooms.keys().next().value}`;
    debug("fast publish to %s", topic);
    // fast publish for clients connected with WebSocket
    encodedPackets.forEach(encodedPacket => {
      const isBinary = typeof encodedPacket !== "string";
      // "4" being the message type in the Engine.IO protocol, see https://github.com/socketio/engine.io-protocol
      app.publish(topic, isBinary ? encodedPacket : "4" + encodedPacket, isBinary);
    });
    this.apply(opts, socket => {
      if (socket.conn.transport.name !== "websocket") {
        // classic publish for clients connected with HTTP long-polling
        socket.client.writeToEngine(encodedPackets, basePacketOpts);
      }
    });
  };
}
function subscribe(namespaceName, socket, isNew, rooms) {
  // @ts-ignore
  const sessionId = socket.conn.id;
  // @ts-ignore
  const websocket = socket.conn.transport.socket;
  if (isNew) {
    debug("subscribe connection %s to topic %s", sessionId, namespaceName);
    websocket.subscribe(namespaceName);
  }
  rooms.forEach(room => {
    const topic = `${namespaceName}${SEPARATOR}${room}`; // '#' can be used as wildcard
    debug("subscribe connection %s to topic %s", sessionId, topic);
    websocket.subscribe(topic);
  });
}
function restoreAdapter() {
  socket_io_adapter_1.Adapter.prototype.addAll = addAll;
  socket_io_adapter_1.Adapter.prototype.del = del;
  socket_io_adapter_1.Adapter.prototype.broadcast = broadcast;
}
const toArrayBuffer = buffer => {
  const {
    buffer: arrayBuffer,
    byteOffset,
    byteLength
  } = buffer;
  return arrayBuffer.slice(byteOffset, byteOffset + byteLength);
};
// imported from https://github.com/kolodziejczak-sz/uwebsocket-serve
function serveFile(res /* : HttpResponse */, filepath) {
  const {
    size
  } = (0, fs_1.statSync)(filepath);
  const readStream = (0, fs_1.createReadStream)(filepath);
  const destroyReadStream = () => !readStream.destroyed && readStream.destroy();
  const onError = error => {
    destroyReadStream();
    throw error;
  };
  const onDataChunk = chunk => {
    const arrayBufferChunk = toArrayBuffer(chunk);
    res.cork(() => {
      const lastOffset = res.getWriteOffset();
      const [ok, done] = res.tryEnd(arrayBufferChunk, size);
      if (!done && !ok) {
        readStream.pause();
        res.onWritable(offset => {
          const [ok, done] = res.tryEnd(arrayBufferChunk.slice(offset - lastOffset), size);
          if (!done && ok) {
            readStream.resume();
          }
          return ok;
        });
      }
    });
  };
  res.onAborted(destroyReadStream);
  readStream.on("data", onDataChunk).on("error", onError).on("end", destroyReadStream);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfX2ltcG9ydERlZmF1bHQiLCJtb2QiLCJfX2VzTW9kdWxlIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJwYXRjaEFkYXB0ZXIiLCJyZXN0b3JlQWRhcHRlciIsInNlcnZlRmlsZSIsInNvY2tldF9pb19hZGFwdGVyXzEiLCJyZXF1aXJlIiwiZnNfMSIsImRlYnVnXzEiLCJkZWJ1ZyIsImRlZmF1bHQiLCJTRVBBUkFUT1IiLCJhZGRBbGwiLCJkZWwiLCJicm9hZGNhc3QiLCJBZGFwdGVyIiwicHJvdG90eXBlIiwiYXBwIiwiaWQiLCJyb29tcyIsImlzTmV3Iiwic2lkcyIsImhhcyIsImNhbGwiLCJzb2NrZXQiLCJuc3AiLCJzb2NrZXRzIiwiZ2V0IiwiX3ByZUNvbm5lY3RTb2NrZXRzIiwiY29ubiIsInRyYW5zcG9ydCIsIm5hbWUiLCJzdWJzY3JpYmUiLCJvbiIsInJvb20iLCJzZXNzaW9uSWQiLCJ3ZWJzb2NrZXQiLCJ0b3BpYyIsInVuc3Vic2NyaWJlIiwicGFja2V0Iiwib3B0cyIsInVzZUZhc3RQdWJsaXNoIiwic2l6ZSIsImV4Y2VwdCIsImZsYWdzIiwiYmFzZVBhY2tldE9wdHMiLCJwcmVFbmNvZGVkIiwidm9sYXRpbGUiLCJjb21wcmVzcyIsImVuY29kZWRQYWNrZXRzIiwiZW5jb2RlciIsImVuY29kZSIsImtleXMiLCJuZXh0IiwiZm9yRWFjaCIsImVuY29kZWRQYWNrZXQiLCJpc0JpbmFyeSIsInB1Ymxpc2giLCJhcHBseSIsImNsaWVudCIsIndyaXRlVG9FbmdpbmUiLCJuYW1lc3BhY2VOYW1lIiwidG9BcnJheUJ1ZmZlciIsImJ1ZmZlciIsImFycmF5QnVmZmVyIiwiYnl0ZU9mZnNldCIsImJ5dGVMZW5ndGgiLCJzbGljZSIsInJlcyIsImZpbGVwYXRoIiwic3RhdFN5bmMiLCJyZWFkU3RyZWFtIiwiY3JlYXRlUmVhZFN0cmVhbSIsImRlc3Ryb3lSZWFkU3RyZWFtIiwiZGVzdHJveWVkIiwiZGVzdHJveSIsIm9uRXJyb3IiLCJlcnJvciIsIm9uRGF0YUNodW5rIiwiY2h1bmsiLCJhcnJheUJ1ZmZlckNodW5rIiwiY29yayIsImxhc3RPZmZzZXQiLCJnZXRXcml0ZU9mZnNldCIsIm9rIiwiZG9uZSIsInRyeUVuZCIsInBhdXNlIiwib25Xcml0YWJsZSIsIm9mZnNldCIsInJlc3VtZSIsIm9uQWJvcnRlZCJdLCJzb3VyY2VzIjpbInV3cy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbnZhciBfX2ltcG9ydERlZmF1bHQgPSAodGhpcyAmJiB0aGlzLl9faW1wb3J0RGVmYXVsdCkgfHwgZnVuY3Rpb24gKG1vZCkge1xuICAgIHJldHVybiAobW9kICYmIG1vZC5fX2VzTW9kdWxlKSA/IG1vZCA6IHsgXCJkZWZhdWx0XCI6IG1vZCB9O1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmV4cG9ydHMucGF0Y2hBZGFwdGVyID0gcGF0Y2hBZGFwdGVyO1xuZXhwb3J0cy5yZXN0b3JlQWRhcHRlciA9IHJlc3RvcmVBZGFwdGVyO1xuZXhwb3J0cy5zZXJ2ZUZpbGUgPSBzZXJ2ZUZpbGU7XG5jb25zdCBzb2NrZXRfaW9fYWRhcHRlcl8xID0gcmVxdWlyZShcInNvY2tldC5pby1hZGFwdGVyXCIpO1xuY29uc3QgZnNfMSA9IHJlcXVpcmUoXCJmc1wiKTtcbmNvbnN0IGRlYnVnXzEgPSBfX2ltcG9ydERlZmF1bHQocmVxdWlyZShcImRlYnVnXCIpKTtcbmNvbnN0IGRlYnVnID0gKDAsIGRlYnVnXzEuZGVmYXVsdCkoXCJzb2NrZXQuaW86YWRhcHRlci11d3NcIik7XG5jb25zdCBTRVBBUkFUT1IgPSBcIlxceDFmXCI7IC8vIHNlZSBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9EZWxpbWl0ZXIjQVNDSUlfZGVsaW1pdGVkX3RleHRcbmNvbnN0IHsgYWRkQWxsLCBkZWwsIGJyb2FkY2FzdCB9ID0gc29ja2V0X2lvX2FkYXB0ZXJfMS5BZGFwdGVyLnByb3RvdHlwZTtcbmZ1bmN0aW9uIHBhdGNoQWRhcHRlcihhcHAgLyogOiBUZW1wbGF0ZWRBcHAgKi8pIHtcbiAgICBzb2NrZXRfaW9fYWRhcHRlcl8xLkFkYXB0ZXIucHJvdG90eXBlLmFkZEFsbCA9IGZ1bmN0aW9uIChpZCwgcm9vbXMpIHtcbiAgICAgICAgY29uc3QgaXNOZXcgPSAhdGhpcy5zaWRzLmhhcyhpZCk7XG4gICAgICAgIGFkZEFsbC5jYWxsKHRoaXMsIGlkLCByb29tcyk7XG4gICAgICAgIGNvbnN0IHNvY2tldCA9IHRoaXMubnNwLnNvY2tldHMuZ2V0KGlkKSB8fCB0aGlzLm5zcC5fcHJlQ29ubmVjdFNvY2tldHMuZ2V0KGlkKTtcbiAgICAgICAgaWYgKCFzb2NrZXQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc29ja2V0LmNvbm4udHJhbnNwb3J0Lm5hbWUgPT09IFwid2Vic29ja2V0XCIpIHtcbiAgICAgICAgICAgIHN1YnNjcmliZSh0aGlzLm5zcC5uYW1lLCBzb2NrZXQsIGlzTmV3LCByb29tcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlzTmV3KSB7XG4gICAgICAgICAgICBzb2NrZXQuY29ubi5vbihcInVwZ3JhZGVcIiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJvb21zID0gdGhpcy5zaWRzLmdldChpZCk7XG4gICAgICAgICAgICAgICAgaWYgKHJvb21zKSB7XG4gICAgICAgICAgICAgICAgICAgIHN1YnNjcmliZSh0aGlzLm5zcC5uYW1lLCBzb2NrZXQsIGlzTmV3LCByb29tcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHNvY2tldF9pb19hZGFwdGVyXzEuQWRhcHRlci5wcm90b3R5cGUuZGVsID0gZnVuY3Rpb24gKGlkLCByb29tKSB7XG4gICAgICAgIGRlbC5jYWxsKHRoaXMsIGlkLCByb29tKTtcbiAgICAgICAgY29uc3Qgc29ja2V0ID0gdGhpcy5uc3Auc29ja2V0cy5nZXQoaWQpIHx8IHRoaXMubnNwLl9wcmVDb25uZWN0U29ja2V0cy5nZXQoaWQpO1xuICAgICAgICBpZiAoc29ja2V0ICYmIHNvY2tldC5jb25uLnRyYW5zcG9ydC5uYW1lID09PSBcIndlYnNvY2tldFwiKSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBjb25zdCBzZXNzaW9uSWQgPSBzb2NrZXQuY29ubi5pZDtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGNvbnN0IHdlYnNvY2tldCA9IHNvY2tldC5jb25uLnRyYW5zcG9ydC5zb2NrZXQ7XG4gICAgICAgICAgICBjb25zdCB0b3BpYyA9IGAke3RoaXMubnNwLm5hbWV9JHtTRVBBUkFUT1J9JHtyb29tfWA7XG4gICAgICAgICAgICBkZWJ1ZyhcInVuc3Vic2NyaWJlIGNvbm5lY3Rpb24gJXMgZnJvbSB0b3BpYyAlc1wiLCBzZXNzaW9uSWQsIHRvcGljKTtcbiAgICAgICAgICAgIHdlYnNvY2tldC51bnN1YnNjcmliZSh0b3BpYyk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHNvY2tldF9pb19hZGFwdGVyXzEuQWRhcHRlci5wcm90b3R5cGUuYnJvYWRjYXN0ID0gZnVuY3Rpb24gKHBhY2tldCwgb3B0cykge1xuICAgICAgICBjb25zdCB1c2VGYXN0UHVibGlzaCA9IG9wdHMucm9vbXMuc2l6ZSA8PSAxICYmIG9wdHMuZXhjZXB0LnNpemUgPT09IDA7XG4gICAgICAgIGlmICghdXNlRmFzdFB1Ymxpc2gpIHtcbiAgICAgICAgICAgIGJyb2FkY2FzdC5jYWxsKHRoaXMsIHBhY2tldCwgb3B0cyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZmxhZ3MgPSBvcHRzLmZsYWdzIHx8IHt9O1xuICAgICAgICBjb25zdCBiYXNlUGFja2V0T3B0cyA9IHtcbiAgICAgICAgICAgIHByZUVuY29kZWQ6IHRydWUsXG4gICAgICAgICAgICB2b2xhdGlsZTogZmxhZ3Mudm9sYXRpbGUsXG4gICAgICAgICAgICBjb21wcmVzczogZmxhZ3MuY29tcHJlc3MsXG4gICAgICAgIH07XG4gICAgICAgIHBhY2tldC5uc3AgPSB0aGlzLm5zcC5uYW1lO1xuICAgICAgICBjb25zdCBlbmNvZGVkUGFja2V0cyA9IHRoaXMuZW5jb2Rlci5lbmNvZGUocGFja2V0KTtcbiAgICAgICAgY29uc3QgdG9waWMgPSBvcHRzLnJvb21zLnNpemUgPT09IDBcbiAgICAgICAgICAgID8gdGhpcy5uc3AubmFtZVxuICAgICAgICAgICAgOiBgJHt0aGlzLm5zcC5uYW1lfSR7U0VQQVJBVE9SfSR7b3B0cy5yb29tcy5rZXlzKCkubmV4dCgpLnZhbHVlfWA7XG4gICAgICAgIGRlYnVnKFwiZmFzdCBwdWJsaXNoIHRvICVzXCIsIHRvcGljKTtcbiAgICAgICAgLy8gZmFzdCBwdWJsaXNoIGZvciBjbGllbnRzIGNvbm5lY3RlZCB3aXRoIFdlYlNvY2tldFxuICAgICAgICBlbmNvZGVkUGFja2V0cy5mb3JFYWNoKChlbmNvZGVkUGFja2V0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpc0JpbmFyeSA9IHR5cGVvZiBlbmNvZGVkUGFja2V0ICE9PSBcInN0cmluZ1wiO1xuICAgICAgICAgICAgLy8gXCI0XCIgYmVpbmcgdGhlIG1lc3NhZ2UgdHlwZSBpbiB0aGUgRW5naW5lLklPIHByb3RvY29sLCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3NvY2tldGlvL2VuZ2luZS5pby1wcm90b2NvbFxuICAgICAgICAgICAgYXBwLnB1Ymxpc2godG9waWMsIGlzQmluYXJ5ID8gZW5jb2RlZFBhY2tldCA6IFwiNFwiICsgZW5jb2RlZFBhY2tldCwgaXNCaW5hcnkpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5hcHBseShvcHRzLCAoc29ja2V0KSA9PiB7XG4gICAgICAgICAgICBpZiAoc29ja2V0LmNvbm4udHJhbnNwb3J0Lm5hbWUgIT09IFwid2Vic29ja2V0XCIpIHtcbiAgICAgICAgICAgICAgICAvLyBjbGFzc2ljIHB1Ymxpc2ggZm9yIGNsaWVudHMgY29ubmVjdGVkIHdpdGggSFRUUCBsb25nLXBvbGxpbmdcbiAgICAgICAgICAgICAgICBzb2NrZXQuY2xpZW50LndyaXRlVG9FbmdpbmUoZW5jb2RlZFBhY2tldHMsIGJhc2VQYWNrZXRPcHRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfTtcbn1cbmZ1bmN0aW9uIHN1YnNjcmliZShuYW1lc3BhY2VOYW1lLCBzb2NrZXQsIGlzTmV3LCByb29tcykge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBzZXNzaW9uSWQgPSBzb2NrZXQuY29ubi5pZDtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3Qgd2Vic29ja2V0ID0gc29ja2V0LmNvbm4udHJhbnNwb3J0LnNvY2tldDtcbiAgICBpZiAoaXNOZXcpIHtcbiAgICAgICAgZGVidWcoXCJzdWJzY3JpYmUgY29ubmVjdGlvbiAlcyB0byB0b3BpYyAlc1wiLCBzZXNzaW9uSWQsIG5hbWVzcGFjZU5hbWUpO1xuICAgICAgICB3ZWJzb2NrZXQuc3Vic2NyaWJlKG5hbWVzcGFjZU5hbWUpO1xuICAgIH1cbiAgICByb29tcy5mb3JFYWNoKChyb29tKSA9PiB7XG4gICAgICAgIGNvbnN0IHRvcGljID0gYCR7bmFtZXNwYWNlTmFtZX0ke1NFUEFSQVRPUn0ke3Jvb219YDsgLy8gJyMnIGNhbiBiZSB1c2VkIGFzIHdpbGRjYXJkXG4gICAgICAgIGRlYnVnKFwic3Vic2NyaWJlIGNvbm5lY3Rpb24gJXMgdG8gdG9waWMgJXNcIiwgc2Vzc2lvbklkLCB0b3BpYyk7XG4gICAgICAgIHdlYnNvY2tldC5zdWJzY3JpYmUodG9waWMpO1xuICAgIH0pO1xufVxuZnVuY3Rpb24gcmVzdG9yZUFkYXB0ZXIoKSB7XG4gICAgc29ja2V0X2lvX2FkYXB0ZXJfMS5BZGFwdGVyLnByb3RvdHlwZS5hZGRBbGwgPSBhZGRBbGw7XG4gICAgc29ja2V0X2lvX2FkYXB0ZXJfMS5BZGFwdGVyLnByb3RvdHlwZS5kZWwgPSBkZWw7XG4gICAgc29ja2V0X2lvX2FkYXB0ZXJfMS5BZGFwdGVyLnByb3RvdHlwZS5icm9hZGNhc3QgPSBicm9hZGNhc3Q7XG59XG5jb25zdCB0b0FycmF5QnVmZmVyID0gKGJ1ZmZlcikgPT4ge1xuICAgIGNvbnN0IHsgYnVmZmVyOiBhcnJheUJ1ZmZlciwgYnl0ZU9mZnNldCwgYnl0ZUxlbmd0aCB9ID0gYnVmZmVyO1xuICAgIHJldHVybiBhcnJheUJ1ZmZlci5zbGljZShieXRlT2Zmc2V0LCBieXRlT2Zmc2V0ICsgYnl0ZUxlbmd0aCk7XG59O1xuLy8gaW1wb3J0ZWQgZnJvbSBodHRwczovL2dpdGh1Yi5jb20va29sb2R6aWVqY3phay1zei91d2Vic29ja2V0LXNlcnZlXG5mdW5jdGlvbiBzZXJ2ZUZpbGUocmVzIC8qIDogSHR0cFJlc3BvbnNlICovLCBmaWxlcGF0aCkge1xuICAgIGNvbnN0IHsgc2l6ZSB9ID0gKDAsIGZzXzEuc3RhdFN5bmMpKGZpbGVwYXRoKTtcbiAgICBjb25zdCByZWFkU3RyZWFtID0gKDAsIGZzXzEuY3JlYXRlUmVhZFN0cmVhbSkoZmlsZXBhdGgpO1xuICAgIGNvbnN0IGRlc3Ryb3lSZWFkU3RyZWFtID0gKCkgPT4gIXJlYWRTdHJlYW0uZGVzdHJveWVkICYmIHJlYWRTdHJlYW0uZGVzdHJveSgpO1xuICAgIGNvbnN0IG9uRXJyb3IgPSAoZXJyb3IpID0+IHtcbiAgICAgICAgZGVzdHJveVJlYWRTdHJlYW0oKTtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfTtcbiAgICBjb25zdCBvbkRhdGFDaHVuayA9IChjaHVuaykgPT4ge1xuICAgICAgICBjb25zdCBhcnJheUJ1ZmZlckNodW5rID0gdG9BcnJheUJ1ZmZlcihjaHVuayk7XG4gICAgICAgIHJlcy5jb3JrKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RPZmZzZXQgPSByZXMuZ2V0V3JpdGVPZmZzZXQoKTtcbiAgICAgICAgICAgIGNvbnN0IFtvaywgZG9uZV0gPSByZXMudHJ5RW5kKGFycmF5QnVmZmVyQ2h1bmssIHNpemUpO1xuICAgICAgICAgICAgaWYgKCFkb25lICYmICFvaykge1xuICAgICAgICAgICAgICAgIHJlYWRTdHJlYW0ucGF1c2UoKTtcbiAgICAgICAgICAgICAgICByZXMub25Xcml0YWJsZSgob2Zmc2V0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IFtvaywgZG9uZV0gPSByZXMudHJ5RW5kKGFycmF5QnVmZmVyQ2h1bmsuc2xpY2Uob2Zmc2V0IC0gbGFzdE9mZnNldCksIHNpemUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWRvbmUgJiYgb2spIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWRTdHJlYW0ucmVzdW1lKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9rO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9O1xuICAgIHJlcy5vbkFib3J0ZWQoZGVzdHJveVJlYWRTdHJlYW0pO1xuICAgIHJlYWRTdHJlYW1cbiAgICAgICAgLm9uKFwiZGF0YVwiLCBvbkRhdGFDaHVuaylcbiAgICAgICAgLm9uKFwiZXJyb3JcIiwgb25FcnJvcilcbiAgICAgICAgLm9uKFwiZW5kXCIsIGRlc3Ryb3lSZWFkU3RyZWFtKTtcbn1cbiJdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWTs7QUFDWixJQUFJQSxlQUFlLEdBQUksVUFBUSxTQUFLQSxlQUFlLElBQUssVUFBVUMsR0FBRyxFQUFFO0VBQ25FLE9BQVFBLEdBQUcsSUFBSUEsR0FBRyxDQUFDQyxVQUFVLEdBQUlELEdBQUcsR0FBRztJQUFFLFNBQVMsRUFBRUE7RUFBSSxDQUFDO0FBQzdELENBQUM7QUFDREUsTUFBTSxDQUFDQyxjQUFjLENBQUNDLE9BQU8sRUFBRSxZQUFZLEVBQUU7RUFBRUMsS0FBSyxF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