(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[439],{9268:function(e,n,r){"use strict";r.r(n),r.d(n,{default:function(){return g}});var s=r(3299),t=r(1163),a=r(7294),i=r(29),o=r(6687),c=r(4687),l=r.n(c),d=r(7642),u=r(2947);r(4675);var x=r(7383),h=r(5893),f=r(3454);function m(){var e,n,r,t,c,m,p=(0,s.useSession)().data,v=(0,a.useState)([]),g=v[0],b=v[1],j=(0,a.useState)(null),N=j[0],w=j[1],y=(0,a.useState)(""),k=y[0],_=y[1],E=(0,a.useState)(0),S=E[0],T=E[1],A=(0,a.useRef)(null),Z=(0,a.useRef)(null);(0,a.useEffect)(function(){var e;if(null!=p&&null!==(e=p.user)&&void 0!==e&&e.id)return A.current=(0,d.io)(f.env.NEXTAUTH_URL||"http://localhost:3000"),A.current.on("new_message",function(e){b(function(n){var r=(0,o.Z)(n),s=r.find(function(n){return n.id===e.conversationId});return s&&s.messages.push(e),r}),e.sender.id!==p.user.id&&u.Am.info("New message from ".concat(e.sender.name))}),A.current.on("message_read",function(e){b(function(n){var r=(0,o.Z)(n);return r.forEach(function(n){n.messages.forEach(function(n){n.id===e&&(n.read=!0)})}),r})}),A.current.on("unread_count_update",function(e){T(e)}),C(),function(){A.current&&A.current.disconnect()}},[null==p||null===(t=p.user)||void 0===t?void 0:t.id]);var C=(e=(0,i.Z)(l().mark(function e(){var n,r;return l().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("/api/conversations/doctor");case 3:return n=e.sent,e.next=6,n.json();case 6:b(r=e.sent),T(r.reduce(function(e,n){return e+n.messages.filter(function(e){var n;return!e.read&&e.sender.id!==(null==p||null===(n=p.user)||void 0===n?void 0:n.id)}).length},0)),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(0),console.error("Error fetching conversations:",e.t0),u.Am.error("Failed to load conversations");case 16:case"end":return e.stop()}},e,null,[[0,12]])})),function(){return e.apply(this,arguments)}),F=(n=(0,i.Z)(l().mark(function e(n){var r;return l().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n.preventDefault(),!(!k.trim()||!N)){e.next=3;break}return e.abrupt("return");case 3:if(e.prev=3,r=g.find(function(e){return e.id===N})){e.next=7;break}return e.abrupt("return");case 7:return e.next=9,fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:k,conversationId:N,receiverId:r.patient.id})});case 9:if(e.sent.ok){e.next=12;break}throw Error("Failed to send message");case 12:_(""),R(),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(3),console.error("Error sending message:",e.t0),u.Am.error("Failed to send message");case 20:case"end":return e.stop()}},e,null,[[3,16]])})),function(e){return n.apply(this,arguments)}),P=(r=(0,i.Z)(l().mark(function e(n){return l().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("/api/messages/".concat(n,"/read"),{method:"PUT"});case 3:if(e.sent.ok){e.next=6;break}throw Error("Failed to mark message as read");case 6:e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("Error marking message as read:",e.t0),u.Am.error("Failed to mark message as read");case 12:case"end":return e.stop()}},e,null,[[0,8]])})),function(e){return r.apply(this,arguments)}),R=function(){var e;null===(e=Z.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};return(0,h.jsxs)("div",{className:"flex h-[calc(100vh-4rem)]",children:[(0,h.jsx)(u.Ix,{position:"top-right"}),(0,h.jsxs)("div",{className:"w-1/3 border-r flex flex-col",children:[(0,h.jsxs)("div",{className:"p-4 border-b",children:[(0,h.jsx)("h2",{className:"text-xl font-semibold",children:"Messages"}),S>0&&(0,h.jsx)("span",{className:"bg-blue-500 text-white px-2 py-1 rounded-full text-sm",children:S})]}),(0,h.jsx)("div",{className:"p-4",children:(0,h.jsx)(x.Z,{onConversationCreated:function(){C()}})}),(0,h.jsx)("div",{className:"flex-1 overflow-y-auto",children:g.map(function(e){var n;return(0,h.jsx)("div",{className:"p-4 border-b cursor-pointer hover:bg-gray-50 ".concat(N===e.id?"bg-gray-100":""),onClick:function(){return w(e.id)},children:(0,h.jsxs)("div",{className:"flex items-center",children:[(0,h.jsx)("img",{src:e.patient.image||"/default-avatar.png",alt:e.patient.name,className:"w-10 h-10 rounded-full mr-3"}),(0,h.jsxs)("div",{children:[(0,h.jsx)("h3",{className:"font-medium",children:e.patient.name}),(0,h.jsx)("p",{className:"text-sm text-gray-500",children:(null===(n=e.messages[e.messages.length-1])||void 0===n?void 0:n.content)||"No messages"})]})]})},e.id)})})]}),(0,h.jsx)("div",{className:"flex-1 flex flex-col",children:N?(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)("div",{className:"p-4 border-b",children:(0,h.jsx)("h2",{className:"text-xl font-semibold",children:null===(c=g.find(function(e){return e.id===N}))||void 0===c?void 0:c.patient.name})}),(0,h.jsxs)("div",{className:"flex-1 overflow-y-auto p-4",children:[null===(m=g.find(function(e){return e.id===N}))||void 0===m?void 0:m.messages.map(function(e){var n,r;return(0,h.jsx)("div",{className:"mb-4 ".concat(e.sender.id===(null==p||null===(n=p.user)||void 0===n?void 0:n.id)?"text-right":"text-left"),children:(0,h.jsxs)("div",{className:"inline-block p-3 rounded-lg ".concat(e.sender.id===(null==p||null===(r=p.user)||void 0===r?void 0:r.id)?"bg-blue-500 text-white":"bg-gray-100"),onMouseEnter:function(){var n;e.read||e.sender.id===(null==p||null===(n=p.user)||void 0===n?void 0:n.id)||P(e.id)},children:[(0,h.jsx)("p",{children:e.content}),(0,h.jsx)("span",{className:"text-xs opacity-75",children:new Date(e.createdAt).toLocaleTimeString()})]})},e.id)}),(0,h.jsx)("div",{ref:Z})]}),(0,h.jsx)("form",{onSubmit:F,className:"p-4 border-t",children:(0,h.jsxs)("div",{className:"flex gap-2",children:[(0,h.jsx)("input",{type:"text",value:k,onChange:function(e){return _(e.target.value)},placeholder:"Type a message...",className:"flex-1 p-2 border rounded-lg"}),(0,h.jsx)("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600",children:"Send"})]})})]}):(0,h.jsx)("div",{className:"flex-1 flex items-center justify-center text-gray-500",children:"Select a conversation to start messaging"})})]})}var p=r(2111),v=r(756);function g(){var e=(0,s.useSession)(),n=e.data,r=e.status,i=(0,t.useRouter)();return((0,a.useEffect)(function(){"unauthenticated"===r&&i.push("/auth/signin")},[r,i]),"loading"===r)?(0,h.jsx)("div",{children:"Loading..."}):null!=n&&n.user?(0,h.jsx)(v.Z,{allowedRoles:["doctor"],children:(0,h.jsx)(p.Z,{children:(0,h.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[(0,h.jsx)("h1",{className:"text-3xl font-bold mb-8",children:"Doctor Dashboard"}),(0,h.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[(0,h.jsx)("div",{className:"lg:col-span-2",children:(0,h.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,h.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Messages"}),(0,h.jsx)(m,{})]})}),(0,h.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,h.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Quick Actions"}),(0,h.jsxs)("div",{className:"space-y-4",children:[(0,h.jsx)("button",{className:"w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600",children:"View Appointments"}),(0,h.jsx)("button",{className:"w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600",children:"Write Prescription"}),(0,h.jsx)("button",{className:"w-full bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600",children:"View Patient Records"})]})]})]})]})})}):null}},241:function(e,n,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/doctor/dashboard",function(){return r(9268)}])}},function(e){e.O(0,[426,537,888,774,179],function(){return e(e.s=241)}),_N_E=e.O()}]);