(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[518],{2773:function(e,n,t){"use strict";t.d(n,{Z:function(){return r}});var s=t(5893);function r(e){var n=e.size,t=e.className;return(0,s.jsx)("div",{className:"".concat(void 0===t?"":t," flex items-center justify-center"),children:(0,s.jsxs)("svg",{className:"".concat({sm:"h-4 w-4",md:"h-8 w-8",lg:"h-12 w-12"}[void 0===n?"md":n]," animate-spin text-blue-600"),xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})})}},8521:function(e,n,t){"use strict";function s(e){return new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}function r(e){var n="string"==typeof e?new Date(e):e,t=Math.floor((new Date().getTime()-n.getTime())/1e3),s=Math.floor(t/31536e3);return s>=1?1===s?"1 year ago":"".concat(s," years ago"):(s=Math.floor(t/2592e3))>=1?1===s?"1 month ago":"".concat(s," months ago"):(s=Math.floor(t/86400))>=1?1===s?"1 day ago":"".concat(s," days ago"):(s=Math.floor(t/3600))>=1?1===s?"1 hour ago":"".concat(s," hours ago"):(s=Math.floor(t/60))>=1?1===s?"1 minute ago":"".concat(s," minutes ago"):t<10?"just now":"".concat(Math.floor(t)," seconds ago")}t.d(n,{Sy:function(){return r},p6:function(){return s}})},2845:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return y}});var s=t(3299),r=t(1163),a=t(7294),i=t(29),o=t(6687),l=t(4687),c=t.n(l),d=t(7642),u=t(2947);t(4675);var f=t(7383),m=t(2773),x=t(5893),h={info:"bg-blue-100 border-blue-500 text-blue-800",success:"bg-green-100 border-green-500 text-green-800",error:"bg-red-100 border-red-500 text-red-800",warning:"bg-yellow-100 border-yellow-500 text-yellow-800"},g=function(e){var n=e.message,t=e.type,s=e.duration,r=e.onClose,i=(0,a.useState)(!0),o=i[0],l=i[1];return((0,a.useEffect)(function(){if(s){var e=setTimeout(function(){l(!1),null==r||r()},s);return function(){return clearTimeout(e)}}},[s,r]),o)?(0,x.jsx)("div",{className:"".concat(h[t]," border-l-4 p-4 mb-4 rounded shadow-sm"),children:(0,x.jsxs)("div",{className:"flex items-center justify-between",children:[(0,x.jsx)("div",{className:"flex items-center",children:(0,x.jsx)("span",{className:"font-medium",children:n})}),(0,x.jsx)("button",{onClick:function(){l(!1),null==r||r()},className:"text-gray-500 hover:text-gray-800",children:"\xd7"})]})}):null},v=t(8521),p=t(3454);function b(){var e,n,t,r,l,h,b,j=(0,s.useSession)().data,N=(0,a.useState)([]),y=N[0],w=N[1],k=(0,a.useState)(null),S=k[0],E=k[1],_=(0,a.useState)(""),T=_[0],C=_[1],M=(0,a.useState)(0),A=M[0],Z=M[1],F=(0,a.useRef)(null),P=(0,a.useRef)(null),D=(0,a.useState)(!0),I=D[0],O=D[1],R=(0,a.useState)(null),z=R[0],H=R[1];(0,a.useEffect)(function(){var e;if(null!=j&&null!==(e=j.user)&&void 0!==e&&e.id)return F.current=(0,d.io)(p.env.NEXTAUTH_URL||"http://localhost:3000"),F.current.on("new_message",function(e){w(function(n){var t=(0,o.Z)(n),s=t.find(function(n){return n.id===e.conversationId});return s&&s.messages.push(e),t}),e.sender.id!==j.user.id&&u.Am.info("New message from ".concat(e.sender.name))}),F.current.on("message_read",function(e){w(function(n){var t=(0,o.Z)(n);return t.forEach(function(n){n.messages.forEach(function(n){n.id===e&&(n.read=!0)})}),t})}),F.current.on("unread_count_update",function(e){Z(e)}),L(),function(){F.current&&F.current.disconnect()}},[null==j||null===(r=j.user)||void 0===r?void 0:r.id]);var L=(e=(0,i.Z)(c().mark(function e(){var n,t;return c().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return O(!0),H(null),e.prev=2,e.next=5,fetch("/api/conversations");case 5:if((n=e.sent).ok){e.next=8;break}throw Error("Failed to fetch conversations");case 8:return e.next=10,n.json();case 10:w(t=e.sent),Z(t.reduce(function(e,n){return e+n.messages.filter(function(e){var n;return!e.read&&e.sender.id!==(null==j||null===(n=j.user)||void 0===n?void 0:n.id)}).length},0)),t.length>0&&!S&&E(t[0].id),e.next=22;break;case 17:e.prev=17,e.t0=e.catch(2),console.error("Error fetching conversations:",e.t0),H("Failed to load conversations. Please try again later."),u.Am.error("Failed to load conversations");case 22:return e.prev=22,O(!1),e.finish(22);case 25:case"end":return e.stop()}},e,null,[[2,17,22,25]])})),function(){return e.apply(this,arguments)}),U=(n=(0,i.Z)(c().mark(function e(n){var t;return c().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n.preventDefault(),!(!T.trim()||!S)){e.next=3;break}return e.abrupt("return");case 3:if(e.prev=3,t=y.find(function(e){return e.id===S})){e.next=7;break}return e.abrupt("return");case 7:return e.next=9,fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:T,conversationId:S,receiverId:t.doctor.id})});case 9:if(e.sent.ok){e.next=12;break}throw Error("Failed to send message");case 12:C(""),X(),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(3),console.error("Error sending message:",e.t0),u.Am.error("Failed to send message");case 20:case"end":return e.stop()}},e,null,[[3,16]])})),function(e){return n.apply(this,arguments)}),V=(t=(0,i.Z)(c().mark(function e(n){return c().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("/api/messages/read",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messageIds:[n]})});case 3:if(e.sent.ok){e.next=6;break}throw Error("Failed to mark message as read");case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("Error marking message as read:",e.t0);case 11:case"end":return e.stop()}},e,null,[[0,8]])})),function(e){return t.apply(this,arguments)}),X=function(){setTimeout(function(){var e;null===(e=P.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},100)};return((0,a.useEffect)(function(){if(S){var e=y.find(function(e){return e.id===S});e&&e.messages.forEach(function(e){var n;e.read||e.sender.id===(null==j||null===(n=j.user)||void 0===n?void 0:n.id)||V(e.id)}),X()}},[S,y]),I)?(0,x.jsx)("div",{className:"h-[calc(100vh-4rem)] flex items-center justify-center",children:(0,x.jsx)(m.Z,{size:"lg"})}):z?(0,x.jsx)("div",{className:"h-[calc(100vh-4rem)] flex items-center justify-center",children:(0,x.jsxs)("div",{className:"text-center",children:[(0,x.jsx)(g,{message:z,type:"error"}),(0,x.jsx)("button",{onClick:L,className:"mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600",children:"Try Again"})]})}):(0,x.jsxs)("div",{className:"flex h-[calc(100vh-4rem)]",children:[(0,x.jsx)(u.Ix,{position:"top-right"}),(0,x.jsxs)("div",{className:"w-1/3 border-r flex flex-col",children:[(0,x.jsx)("div",{className:"p-4 border-b",children:(0,x.jsxs)("h2",{className:"text-xl font-semibold flex items-center",children:["Messages",A>0&&(0,x.jsx)("span",{className:"ml-2 bg-blue-500 text-white px-2 py-1 rounded-full text-sm",children:A})]})}),(0,x.jsx)("div",{className:"p-4",children:(0,x.jsx)(f.Z,{onConversationCreated:function(){L()}})}),(0,x.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===y.length?(0,x.jsx)("div",{className:"p-4 text-center text-gray-500",children:"No conversations yet. Start a new one!"}):y.map(function(e){var n=e.messages.filter(function(e){var n;return!e.read&&e.sender.id!==(null==j||null===(n=j.user)||void 0===n?void 0:n.id)}).length,t=e.messages[e.messages.length-1];return(0,x.jsx)("div",{className:"p-4 border-b cursor-pointer hover:bg-gray-50 ".concat(S===e.id?"bg-gray-100":""),onClick:function(){return E(e.id)},children:(0,x.jsxs)("div",{className:"flex items-center",children:[(0,x.jsx)("img",{src:e.doctor.image||"/default-avatar.png",alt:e.doctor.name,className:"w-10 h-10 rounded-full mr-3"}),(0,x.jsxs)("div",{className:"flex-1",children:[(0,x.jsxs)("div",{className:"flex justify-between items-center",children:[(0,x.jsx)("h3",{className:"font-medium",children:e.doctor.name}),t&&(0,x.jsx)("span",{className:"text-xs text-gray-500",children:(0,v.Sy)(t.createdAt)})]}),(0,x.jsxs)("div",{className:"flex justify-between items-center",children:[(0,x.jsx)("p",{className:"text-sm text-gray-500 truncate max-w-[180px]",children:(null==t?void 0:t.content)||"No messages"}),n>0&&(0,x.jsx)("span",{className:"bg-blue-500 text-white text-xs px-2 py-1 rounded-full",children:n})]})]})]})},e.id)})})]}),(0,x.jsx)("div",{className:"flex-1 flex flex-col",children:S?(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"p-4 border-b",children:(0,x.jsx)("h2",{className:"text-xl font-semibold",children:null===(l=y.find(function(e){return e.id===S}))||void 0===l?void 0:l.doctor.name})}),(0,x.jsxs)("div",{className:"flex-1 overflow-y-auto p-4",children:[(null===(h=y.find(function(e){return e.id===S}))||void 0===h?void 0:h.messages.length)===0?(0,x.jsx)("div",{className:"h-full flex items-center justify-center text-gray-500",children:"No messages yet. Start the conversation!"}):null===(b=y.find(function(e){return e.id===S}))||void 0===b?void 0:b.messages.map(function(e){var n,t,s;return(0,x.jsx)("div",{className:"mb-4 ".concat(e.sender.id===(null==j||null===(n=j.user)||void 0===n?void 0:n.id)?"text-right":"text-left"),children:(0,x.jsxs)("div",{className:"inline-block p-3 rounded-lg max-w-[80%] ".concat(e.sender.id===(null==j||null===(t=j.user)||void 0===t?void 0:t.id)?"bg-blue-500 text-white":"bg-gray-100"),onMouseEnter:function(){var n;e.read||e.sender.id===(null==j||null===(n=j.user)||void 0===n?void 0:n.id)||V(e.id)},children:[(0,x.jsx)("p",{className:"break-words",children:e.content}),(0,x.jsxs)("div",{className:"flex items-center justify-end mt-1 text-xs opacity-75 space-x-1",children:[(0,x.jsx)("span",{children:(0,v.p6)(e.createdAt)}),e.sender.id===(null==j||null===(s=j.user)||void 0===s?void 0:s.id)&&(0,x.jsx)("span",{className:"ml-1",children:e.read?"✓✓":"✓"})]})]})},e.id)}),(0,x.jsx)("div",{ref:P})]}),(0,x.jsx)("form",{onSubmit:U,className:"p-4 border-t",children:(0,x.jsxs)("div",{className:"flex gap-2",children:[(0,x.jsx)("input",{type:"text",value:T,onChange:function(e){return C(e.target.value)},placeholder:"Type a message...",className:"flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,x.jsx)("button",{type:"submit",disabled:!T.trim(),className:"bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 disabled:bg-blue-300 disabled:cursor-not-allowed",children:"Send"})]})})]}):(0,x.jsx)("div",{className:"flex-1 flex items-center justify-center text-gray-500",children:"Select a conversation to start messaging"})})]})}var j=t(2111),N=t(756);function y(){var e=(0,s.useSession)(),n=e.data,t=e.status,i=(0,r.useRouter)();return((0,a.useEffect)(function(){"unauthenticated"===t&&i.push("/auth/signin")},[t,i]),"loading"===t)?(0,x.jsx)("div",{children:"Loading..."}):null!=n&&n.user?(0,x.jsx)(N.Z,{allowedRoles:["patient"],children:(0,x.jsx)(j.Z,{children:(0,x.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[(0,x.jsx)("h1",{className:"text-3xl font-bold mb-8",children:"Patient Dashboard"}),(0,x.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[(0,x.jsx)("div",{className:"lg:col-span-2",children:(0,x.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,x.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Messages"}),(0,x.jsx)(b,{})]})}),(0,x.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,x.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Quick Actions"}),(0,x.jsxs)("div",{className:"space-y-4",children:[(0,x.jsx)("button",{className:"w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600",children:"Book Appointment"}),(0,x.jsx)("button",{className:"w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600",children:"View Prescriptions"}),(0,x.jsx)("button",{className:"w-full bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600",children:"Medical History"})]})]})]})]})})}):null}},3443:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/patient/dashboard",function(){return t(2845)}])}},function(e){e.O(0,[426,537,888,774,179],function(){return e(e.s=3443)}),_N_E=e.O()}]);